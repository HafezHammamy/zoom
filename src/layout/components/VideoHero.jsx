import { Button, Typography, IconButton } from "@mui/material";
import Box from "@mui/material/Box";
import CircularProgress from "@mui/material/CircularProgress";
import Container from "@mui/material/Container";
import Stack from "@mui/material/Stack";
import ArrowDownwardIcon from "@mui/icons-material/ArrowDownward";

import StyledTypography from "layout/components/StyledTypography";
import PropTypes from "prop-types";
import { useState } from "react";
import { keyframes } from "@emotion/react";
import { RouterLink } from "./router-link";

const heroButton = {
  color: "white",
  borderColor: "white",
  height: { xs: "50px", md: "65px" },
  width: { xs: "100%", md: "281px" },
  "&:hover": {
    borderColor: "white",
    color: "#ab92e1",
    backgroundColor: "white",
  },
};

const heroTextStyle = {
  color: "#fff",
  textAlign: { xs: "right", md: "left" },
  alignItems: { xs: "flex-end", md: "flex-start" },
  position: "relative",
  zIndex: 2, // Ensure text appears above overlay
  paddingBottom: { xs: 0, md: "calc(5vh + 75px)" }, // 5vh + ~2cm (75px)
  maxWidth: { xs: "100%", md: "80%" },
  px: { xs: 4, md: 6 }, // نفس الـ padding الموجود في DualSection
};

const videoContainerStyle = {
  position: "absolute",
  top: "50%",
  left: "50%",
  width: "100%",
  height: "100%",
  objectFit: "cover",
  transform: "translate(-50%, -50%) scale(1)", // قلل الزوم
  zIndex: 0,
};

const overlayStyle = {
  position: "absolute",
  top: 0,
  left: 0,
  width: "100%",
  height: "100%",
  backgroundColor: "rgba(0, 0, 0, 0.2)", // Dark overlay with 20% opacity
  zIndex: 1,
};

const loaderStyle = {
  position: "absolute",
  top: "50%",
  left: "50%",
  transform: "translate(-50%, -50%)",
  fontSize: "24px",
  zIndex: 3,
};

const bounce = keyframes`
  0%, 100% {
    transform: translateX(-50%) translateY(0);
  }
  50% {
    transform: translateX(-50%) translateY(10px);
  }
`;

const scrollButtonStyle = {
  position: "absolute",
  bottom: { xs: "15px", md: "85px" }, // Adjusted slightly lower
  left: "50%",
  transform: "translateX(-50%)",
  zIndex: 4,
  backgroundColor: "rgba(255, 255, 255, 0.2)",
  backdropFilter: "blur(10px)",
  border: "2px solid rgba(255, 255, 255, 0.5)",
  borderRadius: "8px",
  width: { xs: "40px", md: "56px" }, // Smaller on mobile
  height: { xs: "40px", md: "56px" }, // Smaller on mobile
  color: "white",
  animation: `${bounce} 2s infinite`,
  "&:hover": {
    backgroundColor: "rgba(255, 255, 255, 0.3)",
    borderColor: "rgba(255, 255, 255, 0.8)",
    transform: "translateX(-50%) translateY(3px)",
  },
  transition: "all 0.3s ease",
};

export const VideoHero = ({
  title,
  title2,
  description,
  videoSrc,
  actionPath,
  actionLabel,
  actionOnClick,
}) => {
  const [isLoading, setIsLoading] = useState(true);

  const handleVideoLoaded = () => {
    setIsLoading(false);
  };

  const handleScrollDown = () => {
    // Get navbar element (header) to calculate its height
    const navbar = document.querySelector("header");
    const navbarHeight = navbar ? navbar.offsetHeight : 120; // Fallback to 120px if not found

    // Scroll to just below the hero section, accounting for navbar height
    window.scrollTo({
      top: window.innerHeight - navbarHeight,
      behavior: "smooth",
    });
  };

  return (
    <Box
      maxWidth="xxl"
      sx={{
        position: "relative",
        height: "100vh",
        width: "100%",
        overflow: "hidden",
        margin: { xs: 0, md: "auto" },
        padding: 0,
        "@media (max-width: 899px)": {
          marginLeft: 0,
          marginRight: 0,
          width: "100vw",
          maxWidth: "100%",
        },
      }}
    >
      {/* Overlay */}
      <Box
        sx={{
          ...overlayStyle,
          "@media (max-width: 899px)": {
            width: "100vw",
            left: 0,
          },
        }}
      />

      {/* Scroll Down Button */}
      <IconButton
        onClick={handleScrollDown}
        sx={scrollButtonStyle}
        aria-label="Scroll down"
      >
        <ArrowDownwardIcon sx={{ fontSize: { xs: "20px", md: "32px" } }} />
      </IconButton>

      {/* Video Background */}
      <video
        autoPlay
        muted
        loop
        playsInline
        style={videoContainerStyle}
        onCanPlay={handleVideoLoaded}
        className="video-hero-mobile-fix"
      >
        <source src={videoSrc} type="video/mp4" />
        Your browser does not support the video tag.
      </video>
      <style>{`
        @media (max-width: 899px) {
          .video-hero-mobile-fix {
            left: 0 !important;
            transform: translateY(-50%) !important;
            width: 100vw !important;
            min-width: 100vw !important;
            margin-left: 0 !important;
            padding-left: 0 !important;
          }
          
          body {
            overflow-x: hidden !important;
          }
        }
      `}</style>

      {/* Content */}
      <Container
        maxWidth="xl"
        sx={{
          position: "relative",
          zIndex: 2,
          height: "100%",
          paddingBottom: { xs: 2, md: 5 },
          marginLeft: { xs: 0, md: "7.5%" },
          px: { xs: 2, md: 0 },
        }}
      >
        <Stack
          alignItems={{ xs: "flex-end", md: "flex-end" }}
          justifyContent={{ xs: "flex-end", md: "flex-start" }}
          spacing={2}
          sx={{
            height: "100%",
            flexDirection: { xs: "column", md: "row" },
            "@media (max-width: 899px)": {
              marginTop: "-40px", // Move content up on mobile
            },
          }}
        >
          <Stack spacing={3} sx={heroTextStyle}>
            {title && (
              <Box sx={{ pr: { xs: 0, md: "-160px" } }}>
                <StyledTypography
                  variant="h2"
                  sx={{
                    fontSize: { xs: "1.5rem", md: "3rem" },
                  }}
                >
                  {title}
                </StyledTypography>
              </Box>
            )}
            {title2 && (
              <Typography
                variant="h3"
                sx={{
                  "@media (max-width: 899px)": {
                    fontSize: "1.25rem",
                  },
                }}
              >
                {title2}
              </Typography>
            )}
            <StyledTypography
              variant="body2"
              sx={{
                maxWidth: { xs: "100%", md: "500px" },
                whiteSpace: "normal",
                wordWrap: "break-word",
                overflowWrap: "break-word",
                textAlign: { xs: "left", md: "justify" },
                "@media (max-width: 899px)": {
                  fontSize: "0.875rem",
                },
              }}
            >
              {description}
            </StyledTypography>
            <Box>
              {actionLabel && (
                <Button
                  sx={heroButton}
                  size="large"
                  variant="outlined"
                  {...(actionOnClick
                    ? { onClick: actionOnClick }
                    : { LinkComponent: RouterLink, href: actionPath })}
                >
                  {actionLabel}
                </Button>
              )}
            </Box>
          </Stack>
        </Stack>
      </Container>

      {/* Loader */}
      {isLoading && (
        <CircularProgress style={loaderStyle} size={60} thickness={5} />
      )}
    </Box>
  );
};

VideoHero.propTypes = {
  onMobileNavOpen: PropTypes.func,
};
